# Copyright 2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
#
- name: "Eject CDROM device from guest OS"
  include_tasks: ../utils/eject_cdrom_in_guest.yml
  when:
    - linux_ovt_repo_url is undefined or not linux_ovt_repo_url
    - guest_os_ansible_distribution in ['SLES', 'SLED', 'RedHat', 'Rocky', 'AlmaLinux']

- name: "Reboot guest OS"
  include_tasks: ../utils/reboot.yml

- name: "Wait for VMware Tools running"
  include_tasks: ../../common/vm_wait_vmtools_status.yml
  vars:
    vm_wait_vmtools_running: true

- name: "Check open-vm-tools plugins and guest OS inbox drivers after reboot"
  when:
    - guest_os_ansible_system == 'Linux'
    - ovt_install_type == 'source'
  block:
    - name: "Check plugins are loaded after reboot"
      include_tasks: check_ovt_plugins_loaded.yml

    - name: "Check inbox drivers are not changed after reboot"
      include_tasks: check_inbox_drivers_unchanged.yml
      when: >-
        guest_os_ansible_distribution != 'VMware Photon OS' or
        guest_os_ansible_distribution_major_ver | int >= 4

- name: "Get VMware Tools version and build"
  include_tasks: ../utils/get_guest_ovt_version_build.yml

- name: "Update VM guest info after installing open-vm-tools"
  include_tasks: ../../common/vm_get_guest_info.yml

- name: "Take a new snapshot and set it as base snapshot"
  include_tasks: ../../common/reset_base_snapshot.yml
