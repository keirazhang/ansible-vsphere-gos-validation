# Copyright 2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Handle guest customization known issues with workarounds
#
# Perl GOSC failure on RHEL/CentOS 10 or their varieties on vCenter Server 8.0.3
- name: "Handle known issue for {{ vm_guest_os_distribution }} on vCenter Server {{ vcenter_version }}"
  when:
    - not enable_cloudinit_gosc | bool
    - vcenter_version is version('8.0.3', '==')
    - guest_os_family == "RedHat"
    - guest_os_network_manager == "NetworkManager"
  block:
    - name: "Check whether /etc/sysconfig/network-scripts exists"
      include_tasks: ../utils/get_file_stat_info.yml
      vars:
        guest_file_path: "/etc/sysconfig/network-scripts"

    - name: "Add Perl GOSC workaround for {{ vm_guest_os_distribution }} on vCenter Server {{ vcenter_version }}"
      when: not guest_file_exists
      block:
        - name: "Create directory /etc/sysconfig/network-scripts on {{ vm_guest_os_distribution }}"
          ansible.builtin.shell: "mkdir -p /etc/sysconfig/network-scripts"
          delegate_to: "{{ vm_guest_ip }}"

        - name: "Known issue - Perl GOSC of {{ vm_guest_os_distribution }} on vCenter Server {{ vcenter_version }}"
          ansible.builtin.debug:
            msg:
              - "Perl guest customization would fail due to not found /etc/sysconfig/network-scripts/ on {{ vm_guest_os_distribution }}."
              - "Please refer to https://issues.redhat.com/browse/RHEL-40365."
              - "Created the directory /etc/sysconfig/network-scripts as a workaround."
          tags:
            - known_issue
